; CRAZY-FIRE  FIT 80 SYSTEM 
;	PART-B
.Z80
;
	EXT	DSET,DISPXX,DISPSS,CLRSXX
	EXT	ERROR
	EXT	PTKR1,PTKR2
	EXT	PTBS1,PTBS2,PTBS3
	EXT	PTBSM,PTSKU
	EXT	PTTAK1,PTTAK2
	EXT	BEEPON,BEEPOF
;
	ENTRY	KIRDS,KIRCL,BASEDS,BASECL
	ENTRY	INTDS,INTCL,CRSDS,CRSCL
	ENTRY	DSTDS,DSTCL,BTLDS,BTLCL
	ENTRY	TAKDS,TAKCL
	ENTRY	WMSLDS,WMSLCL,BSMTBL
	ENTRY	SETKRP,SETBSP,SETTKP
;
STEP	EQU	22*2
HSTEP	EQU	STEP/2
;	
IDCODE	EQU	0	
CSCRAL	EQU	1	
SCRAH	EQU	2	
SUBAL	EQU	3	
SUBAH	EQU	4	
YPOS	EQU	5	
XPOS	EQU	6	
SYPOS	EQU	7	
SXPOS	EQU	8	
DX	EQU	9	
DY	EQU	10	
REPCON	EQU	11	
PATAL	EQU	12	
PATAH	EQU	13	
SMOKAL	EQU	14	
SMOKAH	EQU	15	
ENERGL	EQU	16
ENERGH	EQU	17
MSLSL	EQU	18
MSLSH	EQU	19
MODEF	EQU	20
KILLF	EQU	21
;
KIRDS:	CALL	SETKRP
;	RET	NZ
	JR	NZ,KRD100
	INC	(IX+MODEF)
	LD	(IX+REPCON),8
	CALL	DSET
	CALL	DISPSS
	RET
KRD100:	CALL	DSET
	CALL	DISPXX
	RET
;
KIRCL:	PUSH	IX
	LD	DE,0-HSTEP
	ADD	IX,DE
	DEC	(IX+REPCON)
	LD	DE,PTKR1
	LD	(IX+PATAL),E
	LD	(IX+PATAH),D
;	CALL	SETKRP
;	JR	NZ,KRC100
	CALL	DSET
	CALL	CLRSXX
KRC100:	POP	IX
	RET
;
SETKRP:	LD	A,(IX+MODEF)
	BIT	0,A
	LD	DE,PTKR1
	JR	NZ,SKP100
	LD	DE,PTKR2
SKP100:	LD	(IX+PATAL),E
	LD	(IX+PATAH),D
	LD	A,(IX+REPCON)
	OR	A
	RET
;
SETBSP:	LD	A,(IX+REPCON)
	LD	DE,PTBS1
	OR	A
	JR	Z,SBP100
	LD	DE,PTBS2
	DEC	A
	JR	Z,SBP100
	LD	DE,PTBS3
SBP100:	LD	(IX+PATAL),E
	LD	(IX+PATAH),D
	RET
;
BASEDS:	CALL	SETBSP
	CALL	DSET
	CALL	DISPXX
	RET
;
BASECL:	CALL	SETBSP
	CALL	DSET
	CALL	CLRSXX
	RET
;
BSMTBL:	DEFB	0
	DEFB	4
;
	DEFB	0
	DEFB	0-2
	DEFB	4
	DEFW	PTBSM
	DEFW	PTSKU
	DEFB	2
	DEFB	2
;
WMSLDS:	CALL	DSET
	CALL	DISPXX
	RET
;
WMSLCL:	RET
;
TAKDS:	CALL	SETTKP
	CALL	DSET
	CALL	DISPXX
	RET
;
TAKCL:	CALL	SETTKP
	CALL	DSET
	CALL	CLRSXX
	RET
;
SETTKP:	LD	A,(IX+REPCON)
	BIT	1,A
	LD	DE,PTTAK1
	JR	Z,STK100
	LD	DE,PTTAK2
STK100:	LD	(IX+PATAL),E
	LD	(IX+PATAH),D
	RET
;
INTDS:	CALL	DSET
	CALL	DISPXX
	RET
INTCL:	CALL	DSET
	CALL	CLRSXX
	RET
;
DSTDS:
DSTCL:
CRSDS:
CRSCL:
BTLDS:
BTLCL:
	JP	ERROR
;
	END
ALL	DSET
	CALL	DISPXX
	RET
INTCL:	CALL	DSET
	CALL	CLRSXX
	RET
;
DSTDS:
DSTCL:
CRSDS:
CRSCL:
BTLDS:
BTLCL:
	JP	ERRORIYOUNE!
	LD	B,5
SSS50:	PUSH	BC	
SSS100:	LD	C,(IY+0)	
	LD	B,(IY+1)	
	LD	A,C	
	AND	B	
	INC	A	
	JR	NZ,SSS200	
	LD	C,(IY+2)0
	LD	A,(DMSLF)	
	CPL
	LD	(DMSLF),A	
	OR	A	
	CALL	Z,SHPMSS	
	LD	(DMSLA),IY	
;
	RET		
;
SHPMSS:
;MEMO +HSTEP MO INIT SLD	E,0-3	
	LD	D,0	
	LD	A,(UMSLF)	
	CPL		
	LD	(UMSLF),A	
	OR	A	
	CALL	Z,SHPMSS	
	LD	(UMSLA),IY	
	LD	IY,(DMSLA)	
	LD	DE,1
	OR	(HL)
	LD	(HL),A
	INC	HL
	INC	C
	DJNZ	SMS100
;
	LD	IY,XTBL	
	LD	A,(IY+IDCODE)	
	CP	2	
	RET	NZ	
	LD	IY,(UMSLA)	
	FW	10000
	DEFW	1000
CVTBL2:	DEFW	100
	DEFW	10
	DEFW	1
;
;
SHPMSL: LD	HL,KEYBUF
	LD	B,10
	LD	C,0
SMS100:	IN	A,(C)
	CPLHL=LEFT RESULT
CVSUB:	LD	C,0
CVS100:	OR	A
	SBC	HL,DE
	JR	C,CVS200
	INC	C
	JR	CVS100
CVS200:	ADD	HL,DE
	RET
;
CVTBL:	DENC	IX
	DJNZ	CVD100
	POP	IX
	POP	IY
	LD	HL,CVBUF
	RET
;
;  INPUT:DE=BASE(ex.100,1000),HL=TARGET
;  OUTPUT:C=COUNTED(0-9),
	LD	IX,CVBUF
	LD	B,5
CVD100:	LD	E,(IY+0)
	LD	D,(IY+1)
	CALL	CVSUB
	LD	A,C
	ADD	A,30H
	LD	(IX+0),A
	INC	IY
	INC	IY
	ID	C,5
	JR	DEN200
;
CVBUF:	DEFS	5
; INPUT:HL=TARGET,USE AF,BC,DE,HL
; OUTPUT:[ HL ]
CVDEC::	PUSH	IY
	PUSH	IX
	LD	IY,CVTBLA
	LD	(SCEFLG),A
	LD	B,80H
	LD	C,96-8-4
	CALL	SETCUR
	LD	IX,XTBL
	LD	A,(SCENE)
	LD	L,A
	LD	H,0
	CALL	CVDEC
	LD	B,4
	LIX+MSLSL)
	LD	H,(IX+MSLSH)
DSM100:	CALL	CVDEC
	LD	B,4
	LD	C,5
	JR	DEN200
;
;
DSPSCE:	LD	A,(SCEFLG)
	OR	A
	RET	Z
	XOR	T	Z
	XOR	A
	LD	(MDSFLG),A
	LD	BC,8030H
	CALL	SETCUR
	LD	IX,XTBL
	LD	A,(IX+IDCODE)
	CP	2
	LD	HL,0
	JR	NZ,DSM100
	LD	L,(DEC	C
	DJNZ	DEN200
DEN400:	LD	A,(HL)
	CALL	PUTCHR
	INC	HL
	DEC	C
	JR	NZ,DEN400
	RET
;
DSPSMS:	LD	A,(MDSFLG)
	OR	A
	RE:	CALL	CVDEC
	INC	HL
	INC	HL
	LD	B,2
	LD	C,3
DEN200:	LD	A,(HL)
	CP	30H
	JR	NZ,DEN400
	LD	A,20H
	CALL	PUTCHR
	INC	HL
	
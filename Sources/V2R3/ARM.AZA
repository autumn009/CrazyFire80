;;"ARM V0.01 for KOM980;"Mar.8 1984;"by Aki;SYWORK:EQU $FF40SYWORK:EQU $F220STACK:EQU $FFF0;ASMLOC EQU $9000;;KOM980:EQU TRUE;IF KOM980 THENBNKROM:EQU 0BNKRAM:EQU $80BNKADR:EQU $78PT1200:EQU $30PT600:EQU 0PT300:EQU $10;ENDIF;IF PC8801 THEN;BNKROM EQU 4;BNKRAM EQU 6;BNKADR EQU $31;PT1200 EQU $10;PT600  EQU 0;PT300  EQU $30;ENDIF;;"BOOTER for KOM980/03 ORG $FF40 LD A,$80 OUT ($78),A LD A,$FF OUT ($79),A JP ARM;;; ORG $100 LOCATE ASMLOCARM:JP ARMSTWARM:JP WARMSTCONIN:JP VCINCONOUT:JP VCOTROPEN:JP VROPNWOPEN:JP VWOPNDVSIN:JP VDINDVSOUT:JP VDOTRCLOSE:JP VRCLSWCLOSE:JP VWCLSSENSE:JP VSENSESTPESC:JP VSTOPKEYSCN:JP VKEYSCPRNXT:JP VPRNXTPRSTR:JP VPRSTRPRSPC:JP VPRSPCPRCRLF:JP VCRLFPRDEC:JP VPRDECPR4HEX:JP VPR4HPR2HEX:JP VPR2HLINP:JP VLINPIMGLOD:JP VILODIMGSAV:JP VISAVIMGVER:JP VIVERSTICK:JP VSTICKSTRIG:JP VSTRIGPRTECHO:JP VPECHOBELL:JP VBELLBEEPON:JP VBPONBEEPOF:JP VBPOFWAIT:JP VWAITSETCUR:JP VSTCALOC:JP VALOCMAKEFCB:JP MAKFCBPRDIR:JP VPRDIRCRTC:JP VCRTCCURON:JP VCURONCUROFF:JP VCUROFFPROT:JP VPROTUNPROT:JP VUNPROT;BLANK VECTORS JP ARM JP ARM JP ARM JP ARM JP ARM JP ARM JP ARM JP ARM JP ARM JP ARM;;;ALOCATION MAPALOMAP: DEFB "001" DEFW ARM DEFW ZZZZZZ-1 DEFW SYWORK DEFW KEPBOT-1 DEFW STACK DEFW ARM;KEEPREG EQU $F300-26SCKEEP EQU KEEPREGTPKEEP EQU KEEPREG+2SPKEEP EQU KEEPREG+4IHKEEP EQU KEEPREG+6IDKEEP EQU KEEPREG+8IBKEEP EQU KEEPREG+10IAKEEP EQU KEEPREG+12IYKEEP EQU KEEPREG+14IXKEEP EQU KEEPREG+16HLKEEP EQU KEEPREG+18DEKEEP EQU KEEPREG+20BCKEEP EQU KEEPREG+22AFKEEP EQU KEEPREG+24;KEPBOT EQU KEEPREG+26;REGNAM: DEFB " AF BC DE HL IX IYAF'BC'DE'HL' SPTopSec";SITBL: DEFW 0 DEFB 3 JP VBREAK DEFW 8 DEFB 3 JP VBASIC DEFW $10 DEFB 3 JP VBREAK DEFW $18 DEFB 3 JP CONOUT DEFW $20 DEFB 3 JP CALSUB DEFW $28 DEFB 3 JP VBREAK DEFW $30 DEFB 3 JP VBREAK DEFW $38 DEFB 3 JP VBREAK DEFW $66 DEFB 6 JP VBREAK JP VBREAK DEFW $81 DEFB 3 JP VBASIC DEFW $C9 DEFB 1 RET; DEFW WARM DEFB 3 JP WARMST;;"before NBASIC command DEFW $F16E DEFB 3 JP SYWORK; DEFW $F1DA DEFB 12 JP CALSUB JP SYWORK JP SYWORK JP SYWORK DEFW $F156 DEFB 3 JP SYWORK; DEFW SYWORK DEFB 6 ROMCALL $C9 JP ARM DEFW $FF40 DEFB 7 LD A,BNKRAM OUT (BNKADR),A JP ARM;CALSUB:EQU SYWORK+6 DEFW CALSUB DEFB $1C EX (SP),HL PUSH DE LD E,(HL) INC HL LD D,(HL) INC HL LD (CALSUB+$13),DE POP DE EX (SP),HL PUSH AF LD A,BNKROM OUT (BNKADR),A POP AF CALL $81 PUSH AF LD A,BNKRAM OUT (BNKADR),A POP AF RET DEFW $FFFF;WORKS:EQU CALSUB+$1CCMTFCB:EQU WORKSFNMBUF:EQU WORKS+15SOME EQU FNMBUF+33CMTFLG:EQU SOME+1CURADR:EQU CMTFLG+1CURFCB:EQU CURADR+2VERFLG:EQU CURFCB+2ZURFLG:EQU VERFLG+1LOCKEP:EQU ZURFLG+1KEP2:EQU LOCKEP+2SUBKEEP:EQU KEP2+2SHIFTLAFLG EQU SUBKEEP+2LA EQU SHIFTLAFLG+1;WK:EQU LA+2;;"$11:1200bps;"$12:600bpS;"$13:300bpsCURBOA:DEFB $11;VBASIC:;"Hook cut off LD A,$C9 LD ($F16E),A; ROMCALL $81;VCIN: ROMCALL $F75 RETVCOT: ROMCALL $18 RET;;;print file name(in FCB+1);"HL:FCB+1PRFN: LD B,8PRFN10: LD A,(HL) INC HL CALL CONOUT DJNZ PRFN10 LD A,"." CALL CONOUT LD B,3PRFN20: LD A,(HL) INC HL CALL CONOUT DJNZ PRFN20 RET;;;"a:dvs codeTSTDVS: OR A RET Z AND $F0 CP $F0 RET Z CP $10 RET Z CP $30 RET Z JP UNDDVS;CLRFCB: PUSH HL PUSH DE PUSH BC PUSH AF LD L,E LD H,D INC DE LD (HL),0 LD BC,32 LDIR POP AF POP BC POP DE POP HL RET;;"input:FCF(DE),output:FCB(DE)MAKFCB: PUSH IX PUSH HL PUSH BC PUSH AF EX DE,HL LD A,(CURBOA) LD (BOAD),A LD DE,CMTFCB LD (CURFCB),DE PUSH DE POP IX CALL CLRFCB INC DE PUSH DE LD B,11 LD A," "MFC50: LD (DE),A INC DE DJNZ MFC50 POP DE LD B,9 PUSH DEMFC100: LD A,(HL) INC HL CP "." JR Z,MFC120 OR A JR Z,MFC140 LD (DE),A INC DE DJNZ MFC100 JP FNERRMFC120: EX (SP),HL LD DE,8 ADD HL,DE LD (HL)," " EX DE,HL POP HL LD B,3MFC130: LD A,(HL) INC HL OR A JR Z,MFC135 LD (DE),A INC DE DJNZ MFC130 LD A,(HL) OR A JP NZ,FNERRMFC135: PUSH AFMFC140: POP AF LD DE,(CURFCB) LD A,(CURBOA) LD (DE),A LD (IX+12),1 LD (IX+13),A LD (IX+14),0 ;MON TYPE LD (IX+15),0FNMEEE: POP AF POP BC POP HL POP IX RET;VROPN: PUSH HL PUSH DE PUSH BC PUSH AF LD (CURFCB),DE EX DE,HL LD A,(HL) CALL TSTDVS CP $F0 LD C,0 JP Z,ROPEEE CP $30 JP Z,UNDDVS CP $20 JP Z,UNDDVS LD A,$11 CALL CMTBOA INC HL CALL PRNXT DEFB $D,$A,"Searching ",0 LD A,(HL) CP " " PUSH HL CALL NZ,PRFN POP HL CALL PRCRLFROP190: CALL PRCRLF CALL INEND CALL ININIROP200: LD A,1 LD (SERFLG),A CALL INCHR CP "A" JR NZ,ROP200 CALL INCHR CP "R" JR NZ,ROP200 CALL INCHR CP "M" JR NZ,ROP200 CALL INCHR CP $55 JR NZ,ROP200 CALL INCHR CP $AA JR NZ,ROP200 XOR A LD (SERFLG),A LD B,15 LD DE,FNMBUF LD C,0ROP300: CALL INCHR LD (DE),A INC DE ADD C LD C,A DJNZ ROP300 CALL INCHR CP C PUSH AF CALL PRNXT DEFB "Found ",0 PUSH HL LD HL,FNMBUF CALL PRFN POP HL POP AF JP NZ,HSMERR LD A,(HL) CP " " JR Z,ROP400 LD DE,FNMBUF LD B,11 EX DE,HLROP310: LD A,(DE) CP "?" JR Z,ROP320 CP (HL) JR NZ,ROP190ROP320: INC HL INC DE DJNZ ROP310ROP400: CALL PRCRLF LD HL,(CURFCB) LD DE,12 ADD HL,DE EX DE,HL LD HL,FNMBUF+11 LD BC,4 LDIRROPEEE: LD HL,(CURFCB) LD A,(HL) CALL CMTBOA CALL INEND CALL ININI CALL PRNXT DEFB "*** Found Target ***",0 LD A,1 LD (SERFLG),AROPE10: CALL INCHR CP $AA JR NZ,ROPE10 CALL INCHR CP $55 JR NZ,ROPE10 XOR A LD (SERFLG),A POP AF POP BC POP DE POP HL;LD C,1 RET;VWOPN: PUSH HL PUSH DE PUSH BC PUSH AF LD (CURFCB),DE LD A,$11 CALL CMTBOA CALL OUTINI LD HL,CMTHED LD B,5WOP100: LD A,(HL) INC HL CALL OUTCHR DJNZ WOP100 LD C,0 LD B,15 INC DEWOP200: LD A,(DE) INC DE CALL OUTCHR ADD C LD C,A DJNZ WOP200 LD A,C CALL OUTCHR CALL OUTEND LD DE,(CURFCB) LD A,(DE) CALL CMTBOA CALL OUTINI LD A,$AA CALL OUTCHR LD A,$55 CALL OUTCHR POP AF POP BC POP DE POP HL;LD C,1 RET;CMTHED:DEFB "ARM" DEFB $55 DEFB $AA;VDIN: PUSH HL PUSH DE PUSH BC CALL INCHR POP BC POP DE POP HL RET;VDOT: PUSH HL PUSH DE PUSH BC PUSH AF CALL OUTCHR POP AF POP BC POP DE POP HL RET;VRCLS: PUSH IX PUSH AF CALL INEND POP AF POP IX RET;VWCLS: PUSH IX PUSH AF CALL OUTEND POP AF POP IX RET;VSENSE: PUSH BC; ROMCALL $CF1;;LD B,A;IN A,(9);CPL;AND $81;JR Z,VSEN10;RRA;VSEN10:;LD A,B POP BC RET;VSTOP: PUSH AF CALL SENSE JR Z,VSTP20 JR C,VSTPEXVSTP10: CALL KEYSCN OR A JR NZ,VSTP10VSTP11: CALL CONIN CP 3 JR Z,VSTPEX CP 27 JR Z,VSTP20 LD A,$80 CALL BELL JR VSTP11VSTP20: CALL KEYSCN CP 27 JR Z,VSTP20 POP AF RET;TPBRK: CALL INENDBREAK:VSTPEX: CALL PRNXT DEFB $D,$A,"Break!",7,0 POP AF INC SP INC SP JP ARM;VKEYSC: RST $20  DEFW $FAC RET;VPRNXT: EX (SP),HL PUSH AFVPNX10: LD A,(HL) INC HL OR A JR Z,VPNX20 CALL CONOUT JR VPNX10VPNX20: POP AF EX (SP),HL RET;VPRSTR: PUSH AFVPST10: LD A,(HL) INC HL OR A JR Z,VPST20 CALL CONOUT JR VPST10VPST20: POP AF RET;VPRSPC: PUSH AF LD A," " CALL CONOUT POP AF RET;VCRLF: PUSH AF LD A,13 CALL CONOUT LD A,10 CALL CONOUT POP AF RET;VPRDEC: PUSH HL PUSH DE PUSH BC PUSH AF RST $20  DEFW $2D13 POP AF POP BC POP DE POP HL RET;VPR4H: PUSH AF LD A,H CALL PR2HEX LD A,L CALL PR2HEX POP AF RET;VPR2H: PUSH AF RRA RRA RRA RRA CALL GENHEX CALL CONOUT POP AF PUSH AF CALL GENHEX CALL CONOUT POP AF RET;VLINP: RST $20  DEFW $1B8A RET;VILOD: PUSH IX PUSH HL PUSH DE PUSH BC PUSH AF PUSH DE POP IX LD (IX+14),2 CALL ROPEN PUSH IX LD C,0 LD B,7VIL50: CALL DVSIN LD (IX+16),A INC IX ADD A,C LD C,A DJNZ VIL50 POP IX LD B,3VIL60: CALL DVSIN ADD A,C LD C,A DJNZ VIL60 CALL DVSIN CP C JP NZ,SUMERR; XOR A LD (VERFLG),AVIL100: PUSH DE POP IX PUSH DE CALL EAADJ CALL LODSUB2 POP DE CALL RCLOSE POP AF POP BC POP DE POP HL POP IX RET;VIVER: PUSH IX PUSH HL PUSH DE PUSH BC PUSH AF LD A,1 LD (VERFLG),A JR VIL100;VISAV: PUSH IX PUSH HL PUSH DE PUSH BC PUSH AF PUSH DE POP IX LD (IX+12),1 LD A,(CURBOA) LD (IX+13),A LD (IX+14),2 CALL WOPEN LD HL,16 ADD HL,DE LD B,10 LD C,0ISAV100: LD A,(HL) INC HL CALL DVSOUT ADD A,C LD C,A DJNZ ISAV100 LD A,C CALL DVSOUT PUSH DE CALL EAADJ JR ISAV300;EAADJ: LD L,(IX+16) LD H,(IX+17) LD E,(IX+18) LD D,(IX+19) LD A,(IX+23) OR A JR Z,ISAV200 SBC HL,DE LD E,(IX+24) LD D,(IX+25) ADD HL,DE EX DE,HLISAV200: RET;ISAV300: CALL SAVSUB POP DE CALL WCLOSE POP AF POP BC POP DE POP HL POP IX RET;LODSUB2: LD A,1 LD (SHIFTLAFLG),A LD (LA),HL JR LSB50LODSUB: XOR A LD (SHIFTLAFLG),ALSB50: LD A,1 LD (SERFLG),ALSB100: CALL INCHR CP $3A JR NZ,LSB100 CALL INCHR LD H,A LD C,A CALL INCHR LD L,A ADD C LD C,A CALL INCHR ADD C JP NZ,HSMERR XOR A LD (SERFLG),A LD A,(SHIFTLAFLG) OR A JR Z,LSB200 LD HL,(LA)LSB200: CALL INCHR CP $3A JP NZ,TPRERR CALL INCHR LD B,A LD C,A OR A RET Z ;OSHIMAILBS250: CALL INCHR LD ($F300+76),A PUSH AF LD A,(VERFLG) OR A JR Z,LBS300 POP AF CP (HL) JP NZ,VERERR JR LBS400LBS300: POP AF LD (HL),ALBS400: ADD C LD C,A INC HL DJNZ LBS250 CALL INCHR ADD C JR Z,LSB200 JP SUMERR;"HL:start,DE:endSAVSUB: PUSH HL OR A EX DE,HL SBC HL,DE INC HL EX DE,HL POP HL LD A,$3A CALL OUTCHR LD A,H CALL OUTCHR LD A,L CALL OUTCHR LD A,H ADD L DEFB $ED,$44 ;NEG CALL OUTCHRSVS100: LD A,$3A CALL OUTCHR LD B,255 LD A,D OR A JR NZ,SVS200 LD B,ESVS200: LD A,B CALL OUTCHR LD C,BSVS300: LD A,(HL) INC HL PUSH AF CALL OUTCHR POP AF ADD C LD C,A DEC DE DJNZ SVS300 LD A,C DEFB $ED,$44 ;NEG CALL OUTCHR LD A,E OR D JR NZ,SVS100 LD A,$3A CALL OUTCHR XOR A CALL OUTCHR CALL OUTCHR RET;VSTICK: JP KEYSCNVSTRIG: IN A,(9) CPL AND $40 LD A,$FF RET NZ XOR A RET;VPECHO: JP UNDERR;VBELL: CALL BEEPON CALL WAIT JP   BEEPOF;VBPON: PUSH AF LD A,($EA67) SET 5,A OUT ($40),A LD ($EA67),A POP AF RETVBPOF: PUSH AF LD A,($EA67) RES 5,A OUT ($40),A LD ($EA67),A POP AF RET;VWAIT: PUSH AF PUSH BC LD B,A LD C,0VWAI10: DEC BC LD A,B OR C JR NZ,VWAI10 POP BC POP AF RET;VSTC:LD ($EA63),BC RET;VALOC: LD HL,ALOMAP RET;VCRTC: PUSH HL PUSH DE PUSH BC PUSH AF LD A,(DE) INC DE LD ($EA65),A LD A,(DE) INC DE LD($EA62),A LD A,(DE) INC DE INC A LD($EA5E),A LD A,(DE) INC DE DEC A LD($EA5D),A LD A,(DE) INC DE LD L,A LD A,(DE) INC DE LD H,A LD A,(DE) INC DE PUSH AF LD A,(DE) INC DE LD($EA5A),A PUSH HL LD A,L CPL LD L,A LD A,H CPL LD H,A LD ($EA60),HL POP BC ROMCALL $8F7 POP AF LD ($EA5B),A LD A,12 CALL CONOUT POP AF POP BC POP DE POP HL RET;VCURON: ROMCALL $BE9 RETVCUROFF: ROMCALL $BD2 RET;CMTBOA: AND $F LD B,PT1200 OR A JR Z,CBO200 DEC A JR Z,CBO200 LD B,PT600 DEC A JR Z,CBO200;IF KOM980 THEN LD B,PT300 DEC A JR Z,CBO200;ENDIF JP UNDDVSCBO200: LD A,B LD (BOAD),A RET;FNERR: CALL PRNXT DEFB $D,$A,"File Name Error!",7,0 JP WARM;ADRERR: CALL PRNXT DEFB $D,$A,"Adres Error!",7,0 JP WARM;HSMERR: CALL INEND CALL PRNXT DEFB $D,$A,"Header Sum Error!",7,0 JP WARM;SUMERR: CALL INEND CALL PRNXT DEFB $D,$A,"Check Sum Error!",7,0 JP WARM;VERERR: CALL INEND CALL PRNXT DEFB $D,$A,"Verify Error!",7,0 JP WARM;UNDERR: CALL PRNXT DEFB $D,$A,"Undef!",7,0 JP WARM;DVSUSE: CALL PRNXT DEFB $D,$A,"Device in use!",7,0 JP WARM;UNDDVS: CALL PRNXT DEFB $D,$A,"Undef Device!",7,0 JP WARM;ILLNAM: CALL PRNXT DEFB $D,$A,"Illegal FILE NAME!",7,0 JP WARM;TPRERR: CALL INEND CALL PRNXT DEFB $D,$A,"Tape read error!",7,0 JP WARM;VBREAK:;"same as label:ARMARMST: DI LD (SPKEEP),SP LD SP,STACK CALL UNPROT PUSH AF LD A,BNKRAM OUT (BNKADR),A POP AF LD SP,AFKEEP+2 PUSH AF PUSH BC PUSH DE PUSH HL PUSH IX PUSH IY EX AF,AF' PUSH AF EXX PUSH BC PUSH DE PUSH HL LD SP,(SPKEEP) POP HL LD (TPKEEP),HL POP HL LD (SCKEEP),HLWARMST: LD SP,STACK LD HL,SITBLAIN100: LD E,(HL) INC HL LD D,(HL) INC HL LD A,E AND D INC A JR Z,AIN200 LD B,(HL) INC HLAIN110: LD A,(HL) INC HL LD (DE),A INC DE DJNZ AIN110 JR AIN100AIN200:AIN900: CALL BEEPOF XOR A LD (CMTFLG),A CALL PRCRLFARMCMD: LD HL,ARMTIT CALL PRSTRARMKEY: CALL ARMGET CALL UPPER CP 12 CALL Z,CONOUT JR Z,ARMCMD CP 7 CALL Z,CONOUT JR Z,WARMST CP 32 JR C,AIN900 CALL CONOUT CP "D" JR Z,ARMDUM CP "S" JP Z,ARMSUB CP "G" JP Z,ARMGO CP "X" JP Z,ARMEXM CP "E" JP Z,ARMEXECUTE CP "!" JP Z,VBASIC CP "T" JP Z,TAPE CP "R" JP Z,ARMLOD CP "W" JP Z,ARMSAV CP "V" JP Z,ARMVER CALL ERRED JR ARMKEYERRED: PUSH AF PUSH HL LD HL,ARMERM CALL PRSTR POP HL POP AF RETARMERM: DEFB 7,29,32,29,0;ARMDUM: XOR A LD (WK+1),A CALL GETADR PUSH AF LD A,C OR A JR NZ,ADM40 LD HL,(CURADR)ADM40: POP AF PUSH HL LD DE,127 ADD HL,DE CP "," JR NZ,ADM100 CALL GETADRADM100: EX DE,HL POP HL CALL PRCRLF LD A,L AND $F0 LD L,AADM300: CALL PRIDX JR ADM400;PRIDX: LD C,0 LD B,5ADM310: CALL PRSPC DJNZ ADM310 LD B,16ADM320: LD A,"+" CALL CONOUT LD A,C CALL GENHEX CALL CONOUT CALL PRSPC INC C DJNZ ADM320 LD A,"+" CALL CONOUT LD B,16 LD C,0ADM330: LD A,C CALL GENHEX CALL CONOUT INC C DJNZ ADM330 CALL PRCRLF RET;ADM400: CALL PR16B JR ADM500;PR16B: PUSH HL PUSH DE CALL PR4HEX POP DE POP HL LD A,":" CALL CONOUT PUSH HL LD B,16ADM410: LD A,(HL) CALL PR2HEX CALL PRSPC PUSH HL OR A SBC HL,DE POP HL JR NZ,ADM415 LD A,1 LD (WK+1),AADM415: INC HL LD (CURADR),HL DJNZ ADM410 POP HL LD A,"–" CALL CONOUT LD B,16ADM420: LD A,(HL) INC HL CALL PRDIR JR ADM430;;VPRDIR: PUSH HL PUSH DE PUSH BC PUSH AF LD HL,($EA63) RST $20  DEFW $3F3 POP AF PUSH AF LD (HL),A LD A,28 CALL CONOUT POP AF POP BC POP DE POP HL RET;;ADM430: DJNZ ADM420 LD A,"–" CALL CONOUT CALL STPESC CALL PRCRLF RET;ADM500: LD A,(WK+1) OR A JP NZ,ARMCMD LD A,L OR A JP Z,ADM300 JR ADM400;ARMEXM: CALL PRCRLF LD HL,KEPBOT LD DE,REGNAM LD C,13AEX100: LD B,3AEX110: LD A,(DE) INC DE CALL CONOUT DJNZ AEX110 LD A,":" CALL CONOUT PUSH DE DEC HL LD D,(HL) DEC HL LD E,(HL) EX DE,HL CALL PR4HEX EX DE,HL POP DE CALL PRSPC LD A,8 CP C CALL Z,PRCRLF DEC C JR NZ,AEX100 CALL PRCRLF JP ARMCMD;ARMSUB: CALL GETADR LD A,C OR A JR Z,ASB100 LD (CURADR),HL LD (SUBKEEP),HLASB100: CALL PRCRLF CALL PRIDX CALL ASB3L CALL PRNXT DEFB " > > Ten-Key is Hex-Mode < <",0 LD HL,($EA63) LD (KEP2),HL CALL PRNXT DEFB 30,30,0 LD HL,($EA63) LD H,1 LD (LOCKEP),HLASB190: XOR A LD (ZURFLG),AASB200: CALL CALPOS JR ASB210;CALPOS: LD HL,(LOCKEP) LD ($EA63),HL LD HL,(CURADR) LD A,L AND $F LD B,A ADD A ADD B ADD 6 LD ($EA64),A RET;ASB210: LD A,(ZURFLG) OR A JR Z,ASB220 LD A,($EA64) INC A LD ($EA64),AASB220: LD A,20 CALL BELL CALL TENGET CP 30 JP Z,ROLLUP CP 31 JP Z,ROLLDW CP "N"-$40 JP Z,ROLLDW3 CP "B"-$40 JP Z,ROLLUP3 CP 28 JP Z,RIGHT CP 29 JP Z,LEFT CP 8 JP Z,LEFT CP 11 JP Z,HOME CP 3 JP Z,ASSTOP CP 27 JP Z,ASEXIT CALL HEXEN CALL TSTHEX JR NC,ASDATA LD A,7 CALL CONOUT JR ASB200ASSTOP:LD HL,(SUBKEEP) LD (CURADR),HLASEXIT: LD HL,(KEP2) LD ($EA63),HL LD A,30 CALL CONOUT JP WARMASDATA: CALL CONOUT CALL CHGHEX LD B,A LD C,$F0 LD A,(ZURFLG) OR A JR NZ,ASD100 LD C,$F LD A,B RLCA RLCA RLCA RLCA LD B,AASD100: LD HL,(CURADR) LD A,C AND (HL) OR B LD (HL),A CALL CALPOS LD HL,(CURADR) LD A,(HL) PUSH AF CALL PR2HEX LD A,(CURADR) AND $F ADD A,16*3+5+2 LD ($EA64),A POP AF CALL PRDIR JR RIGHT;ROLLUP3:LD DE,-48 JR ROLCOMROLLDW3:LD DE,48 JR ROLCOMROLLUP: LD DE,-16 JR ROLCOMROLLDW: LD DE,16ROLCOM: LD HL,(CURADR) ADD HL,DE LD (CURADR),HL LD HL,(LOCKEP) DEC L LD ($EA63),HL CALL ASB3L;IF NBASIC_MODE XOR A LD ($EA57),A;ENDIFASB200PASS: JP ASB200;RIGHT: LD A,(ZURFLG) CPL LD (ZURFLG),A OR A JR NZ,ASB200PASS LD DE,1 LD HL,(CURADR) LD A,L AND $F CP $F JR Z,ROLCOM JR HRZCOMLEFT: LD A,(ZURFLG) CPL LD (ZURFLG),A OR A JR Z,ASB200PASS LD DE,-1 LD HL,(CURADR) LD A,L AND $F JR Z,ROLCOMHRZCOM: ADD HL,DE LD (CURADR),HL JR ASB200PASSHOME: LD HL,(SUBKEEP) LD (CURADR),HL XOR A LD (ZURFLG),A LD DE,0 JR ROLCOM;HEXEN: PUSH IX PUSH BC LD IX,HEXENTBL LD B,6HEXN10: CP (IX+0) JR Z,HEXN20 INC IX DJNZ HEXN10 JR HEXN30HEXN20:LD A,(IX+6)HEXN30: POP BC POP IX RET;HEXENTBL:DEFB "*+=",13,".,ABCDEF";TENGET: CALL CONIN CALL UPPER RET;ASB3L: LD HL,(CURADR) PUSH HL LD A,L AND $F0 LD L,A LD DE,0-16 ADD HL,DE LD B,3ASB3L1: PUSH BC CALL PR16B POP BC DJNZ ASB3L1 POP HL LD (CURADR),HL RET;ARMGO: CALL GETADR CP 13 JR NZ,WARMSTPASS LD A,C OR A JR Z,WARMSTPASS CALL PRCRLF LD SP,STACK LD DE,ARM PUSH DE JP (HL);ARMEXECUTE: CALL ARMGET CALL UPPER CP "R" JR Z,ARMER CP 13 JR NZ,WARMSTPASS CALL PRCRLF LD HL,(ALOMAP+13) JP (HL);WARMSTPASS:JP WARMST;ARMER:;CALL GETFN;PUSH DE;POP IX;LD (IX+23),0 ;NO OFFSET;CALL IMGLOD;LD A,(IX+20);OR A;JR Z,WARMSTPASS;;;ARMLOD:ARMSAV:ARMVER: JP UNDERR;TAPE:TAPE10: CALL ARMGET CALL UPPER CP 13 JR Z,TPSTAT CP 1 JP Z,TPHELP CALL CONOUT CP "T" JR Z,TPTHRU CP "S" JR Z,TPSLOW CP "N" JR Z,TPNORM CP "H" JR Z,TPHIGH CP "J" JR Z,TPRY CP "M" JR Z,TPMON CP "'" JP Z,SCRINI CP "!" JP Z,WARM CP 27 JP Z,WARM CALL ERRED JR TAPE10;TPTHRU: LD A,(CURBOA) CALL CMTBOA LD A,1 LD (SERFLG),A CALL ININITPT100: CALL INCHR CALL PRDIR LD A,($EA63) LD B,A LD A,($EA62) DEC A CP B JR NC,TPT100 LD A,1 LD ($EA63),A JR TPT100;TPSTAT: CALL PRTBOA CALL PRTRY JP WARM;TPSLOW:LD A,$13 DEFB 1TPNORM:LD A,$12 DEFB 1TPHIGH:LD A,$11 LD (CURBOA),A CALL PRTBOA JP WARM;TPRY: LD A,($EA66) XOR 8 LD ($EA66),A CALL PRTRY JP WARM;TPMON: LD A,(CURBOA) CALL CMTBOA CALL ARMGET CALL UPPER CP 13 JP Z,WARM CP 27 JP Z,WARM CALL CONOUT CP "L" JR Z,MONLOD CP "V" JR Z,MONVER CP "W" JR Z,MONSAV CALL ERRED JR TPMONMONLOD: XOR AMONLD1: LD (VERFLG),A CALL ININI CALL LODSUB CALL INEND JP WARMMONVER: LD A,1 JR MONLD1MONSAV: CALL GETADR CP 13 JP Z,ADRERR PUSH HL CALL GETADR EX DE,HL POP HL CALL OUTINI CALL SAVSUB CALL OUTEND JP WARM;TPHELP: CALL PRNXT DEFB $D,$A DEFB "Tape Controle Commands",$D,$A DEFB 9,"TT:Direct Tape Dump.",$D,$A DEFB 9,"TJ:Motor invers.",$D,$A DEFB "Set boad rate(bps)",$D,$A DEFB 9,"TS:300",$D,$A DEFB 9,"TN:600",$D,$A DEFB 9,"TH:1200",$D,$A DEFB "N-BASIC Monitor Format Load/Save.",$D,$A DEFB 9,"TML as 'L'",$D,$A DEFB 9,"TMV as 'LV'",$D,$A DEFB 9,"TMW as 'W'",$D,$A DEFB "Others",$D,$A DEFB 9,"T^A:T¥HELP",$D,$A DEFB 9,"T':Screen init.",0 JP WARM;PRTRY: CALL PRNXT DEFB $D,$A,"MOTOR is O",0 LD A,($EA66) OUT ($30),A BIT 3,A LD A,"N" JR NZ,PRY100 LD A,"F" CALL CONOUTPRY100: CALL CONOUT CALL PRPID RET;PRTBOA: LD A,(CURBOA) CALL PRNXT DEFB $D,$A,"Tape Speed is ",0 SUB $11 LD HL,1200 JR Z,PRB100 DEC A LD HL,600 JR Z,PRB100 DEC A LD HL,300 JR Z,PRB100 LD HL,0PRB100: CALL PRDEC CALL PRNXT DEFB " bps",0 CALL PRPID RET;PRPID: LD A,"." CALL CONOUT RET;SCRINI: LD DE,SCRINITBL CALL CRTC JP WARM;SCRINITBL: DEFB 80,25,0,25,0,0,0,32;ARMGET: LD A,"*" CALL CONOUT LD A,29 CALL CONOUT CALL CONIN CP 3 JP Z,WARM PUSH AF LD A,32 CALL CONOUT LD A,29 CALL CONOUT POP AF RET;GETADR: LD HL,0 LD C,0GAD100: PUSH HL CALL ARMGET CALL UPPER CALL CONOUT POP HL CP "," RET Z CP 13 RET Z CALL CHGHEX CALL NC,ERRED JR NC,GAD100 ADD HL,HL ADD HL,HL ADD HL,HL ADD HL,HL LD C,1 LD E,A LD D,0 ADD HL,DE JR GAD100;;;UPPER: CP "a" RET C CP "z"+1 RET NC SUB $20 RET;;"if C then errorTST09: CP "0" RET C CP "9"+1 CCF RET;TSTHEX: CALL TST09 RET NCTSTAF: CP "A" RET C CP "F"+1 CCF RET;;"if nc then errorCHGHEX: SUB $30 CP 10 RET C SUB 7 CP 16 RET;GENHEX: AND $F ADD $30 CP $3A RET C ADD 7 RET;ARMTIT:DEFB "armV0]",0;EXT: LD DE,FNMBUFEXT100: LD A,(HL) LD (DE),A INC HL INC DE OR A JR NZ,EXT100 LD HL,FNMBUF RET;BOAD:DEFB 0;SCREEN: LD HL,CONMES CALL EXT RST $20 DEFW $884 LD HL,WIDMES CALL EXT RST $20 DEFW $843 LD A,$28 LD ($EA5B),A LD A,12 CALL CONOUT LD A,$88 LD ($EA5B),A RET;CONMES:DEFB "0,25,0,0",0WIDMES:DEFB "80,25",0;SERFLG EQU $EF3C;OUTINI: LD A,(CMTFLG) OR A JP NZ,DVSUSE LD A,1 LD (CMTFLG),A LD A,($EA66) AND $F PUSH HL LD HL,BOAD OR (HL) POP HL OR $C LD ($EA66),A OUT ($30),A CALL PCIRES LD A,$CE OUT ($21),A LD A,$11 OUT ($21),A CALL WAIT2 LD A,($EA66) AND $FB LD ($EA66),A OUT ($30),AWAIT1: PUSH DE PUSH HL LD E,1WCOMM: LD HL,0WLOOP: DEC L JR NZ,WLOOP DEC H JR NZ,WLOOP DEC E JR NZ,WLOOP POP HL POP DE RET;WAIT2: PUSH DE PUSH HL LD E,6 JR WCOMM;WAIT3: PUSH DE PUSH HL LD E,3 JR WCOMM;OUTCHR: ROMCALL $CDA RET;;PUSH AF;OTC10:IN A,($21);AND 1;JR NZ,OTC20;IN A,(9);CPL;AND $81  ;IF STOP OR ESC;JR NZ,OTC30 ;THEN ERR RET;JR OTC10;OTC20: POP AF;OUT ($20),A;XOR A;     IF Z THEN NORMAL RETURN;RET;;OTC30: POP AF;OR 255;;RET;OUTEND: CALL WAIT3INEND: ROMCALL $C31;;LD A,($EA66);AND $F7;OR 4;LD ($EA66),A;OUT ($30),A; XOR A LD (CMTFLG),A RET;ININI: LD A,(CMTFLG) OR A JP NZ,DVSUSE LD A,1 LD (CMTFLG),A LD A,($EA66) AND $F PUSH HL LD HL,BOAD OR (HL) POP HL OR 08 LD ($EA66),A OUT ($30),AIII10: IN A,($40) AND 4 JR NZ,III20 IN A,(9) CPL AND $81 RET NZ JR III10III20: IN A,($40) AND 4 JR Z,III10 CALL PCIRES LD A,$4E OUT ($21),A LD A,$14 OUT ($21),A XOR A ;IF Z THEN NORMAL RETURN RET;INCHR: ROMCALL $C88 RET;;IN A,($21);AND 2;JR NZ,INC20;CALL SENSE;JP NZ,TPBRK;JR INCHR;INC20:IN A,($21);CPL;AND $30;CP $30;IN A,($20);JR C,TPRER1;PUSH BC;LD B,A;XOR A;LD A,B;POP BC;  IF Z THEN NORMAL RETURN;RET;PCIRES: ROMCALL $D14 RET;;LD A,$E  ;PCI DESABLE;OUT ($21),A;LD A,$40  ;PCI INTERNAL RESET;OUT ($21),A;RET;;TPRER1:;CALL PCIRES;LD A,$4E;OUT ($21),A;LD A,$14;OUT ($21),A;LD A,(SERFLG);AND A;JP Z,TPRERR;XOR A ;NO ERROR BURIKKO;LD A,1;RET;VPROT:;IF KOM980 THEN;PUSH AF;XOR A;OUT ($79),A;POP AF;ENDIF RETVUNPROT:;IF KOM980 THEN;PUSH AF;LD A,255;OUT ($79),A;POP AF;ENDIF RET;ZZZZZZ:END  T  ÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿ                                                                ÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿ
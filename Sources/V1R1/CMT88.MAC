; PC-8801 CMT (1200BPS ONLY) SUBROUTINES
.Z80
OUTINI::
	LD	A,(0EA66H)
	AND	0FH
	OR	1CH
	LD	(0EA66H),A
	OUT	(30H),A
	CALL	PCIRES
	LD	A,11H
	OUT	(21H),A
	CALL	WAIT2
	LD	A,(0EA66H)
	AND	0FBH
	LD	(0EA66H),A
	OUT	(30H),A
WAIT1::	PUSH	DE
	PUSH	HL
	LD	E,1
WCOMM:	LD	HL,0
WLOOP:	DEC	L
	JR	NZ,WLOOP
	DEC	H
	JR	NZ,WLOOP
	DEC	E
	JR	NZ,WLOOP
	POP	HL
	POP	DE
	RET
;
WAIT2::	PUSH	DE
	PUSH	HL
	LD	E,6
	JR	WCOMM
;
WAIT3::	PUSH	DE
	PUSH	HL
	LD	E,3
	JR	WCOMM
;
OUTCHR::
	PUSH	AF
OTC10:	IN	A,(21H)
	AND	1
	JR	NZ,OTC20
	IN	A,(9)
	CPL
	AND	81H		;IF STOP OR ESC
	RET	NZ		;THEN ERR RET
	JR	OTC10
OTC20:	POP	AF
	OUT	(20H),A
	XOR	A
	RET			;IF Z THEN NORMAL RETURN
;
OUTEND::
	CALL	WAIT3
INEND::	LD	A,(0EA66H)
	AND	0F7H
	OR	4
	LD	(0EA66H),A
	OUT	(30H),A
	RET
;
ININI::	LD	A,(0EA66H)
	AND	0FH
	OR	18H
	LD	(0EA66H),A
	OUT	(30H),A
III10:	IN	A,(40H)
	AND	4
	JR	NZ,III20
	IN	A,(9)
	CPL
	AND	81H
	RET	NZ
	JR	III10
III20:	IN	A,(40H)
	AND	4
	JR	NZ,III10
	CALL	PCIRES
	LD	A,4EH
	OUT	(21H),A
	LD	A,14H
	OUT	(21H),A
	XOR	A
	RET		;IF Z THEN NORMAL RETURN
;
INCHR::	IN	A,(21H)
	AND	2
	JR	NZ,INC20
	IN	A,(9)
	CPL
	AND	81H
	RET	NZ
	JR	INCHR
INC20:	IN	A,(21H)
	CPL
	AND	30H
	CP	30H
	IN	A,(20H)
	JR	C,TPRER1
	PUSH	BC
	LD	B,A
	XOR	A
	LD	A,B
	POP	BC
	RET		;IF Z THEN NORMAL RETURN
;
PCIRES:	LD	A,0EH		;PCI DESABLE
	OUT	(21H),A
	LD	A,40H		;PCI INTERNAL RESET
	OUT	(21H),A
	LD	A,0CEH		;PCI COMMAND
	OUT	(21H),A
	RET
;
TPRER1:	LD	A,(SERFLG)
	AND	A
	LD	A,1
	RET	NZ
	JP	TPRERR##
;
SERFLG::
	DEFB	0
;
ZZZZZZ:	END
 INTERNAL RESET
	OUT	(21H),A
	LD	A,0CEH		;PCI COMMAND
	OUT	(21H),A
	RET
;
TPRER1:	LD	A,(SERFLG)
	AND	A
	LD	A,1
	RET	NZULL!!',7,7,7,0DH,0AH,0
SVMES1:	DEFB	'PUSH SPACE BAR TO START <SAVING>',0DH,0AH,0
SVMES2:	DEFB	'FINISHED SAVING!!!',0DH,0AH,0
BRKMES:	DEFB	'Break',7,0DH,0AH,0
TPRMES:	DEFB	'?WARNIG!!! UNUSED FUNCTION WAS CALLED!',7,7,7,7,7,0DH,0AH,0
;
	END	START
